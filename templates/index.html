<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡æ•°æ®å¤„ç†ç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ•</text></svg>">
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
        .container { background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); padding: 40px; max-width: 1000px; width: 95%; }
        .title { text-align: center; color: #333; margin-bottom: 30px; font-size: 2.5em; font-weight: bold; }
        .step { margin-bottom: 30px; padding: 20px; border: 2px solid #e1e5e9; border-radius: 10px; transition: all 0.3s ease; }
        .step.active { border-color: #667eea; background: #f8f9ff; }
        .step.completed { border-color: #28a745; background: #f8fff9; }
        .step-title { font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 15px; display: flex; align-items: center; }
        .step-number { background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; }
        .completed .step-number { background: #28a745; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s ease; margin-right: 10px; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #333; }
        .file-label { display: inline-block; padding: 12px 24px; background: #667eea; color: white; border-radius: 8px; cursor: pointer; transition: background 0.3s ease; }
        .file-label:hover { background: #5a6fd8; }
        input[type="file"] { display: none; }
        .result { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { display: none; text-align: center; margin: 15px 0; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-info { margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 5px; display: none; }
        .download-area { margin-top: 20px; text-align: center; }
        .error-details { max-height: 300px; overflow-y: auto; margin-top: 10px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 0.9em; }
        .error-item { margin: 5px 0; padding: 3px 0; border-bottom: 1px solid #ddd; }
        .summary-box { background: #e7f3ff; border: 1px solid #b8daff; border-radius: 5px; padding: 15px; margin: 10px 0; }
        .summary-item { display: inline-block; margin: 5px 15px 5px 0; font-weight: bold; }
        .icon { margin-right: 8px; }
        .collapsible { cursor: pointer; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; margin: 5px 0; }
        .collapsible:hover { background: #e9ecef; }
        .content { display: none; padding: 15px; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 5px 5px; }
        .step-options { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ• æ‰“å¡æ•°æ®å¤„ç†ç³»ç»Ÿ</h1>

        <div class="step active" id="step1">
            <div class="step-title">
                <span class="step-number">1</span>
                ä¸Šä¼ Timecardæ–‡ä»¶
            </div>
            <div>
                <label for="file" class="file-label">ğŸ“ é€‰æ‹©Excelæ–‡ä»¶</label>
                <input type="file" id="file" accept=".xlsx,.xls">
                <div class="file-info" id="fileInfo"></div>
            </div>
            <button class="btn" id="uploadBtn" onclick="uploadFile()" disabled>ä¸Šä¼ æ–‡ä»¶</button>
            <div class="loading" id="uploadLoading"><div class="spinner"></div><div>æ­£åœ¨ä¸Šä¼ ...</div></div>
            <div class="result" id="uploadResult"></div>
        </div>

        <div class="step" id="step2">
            <div class="step-title">
                <span class="step-number">2</span>
                æ•°æ®é¢„å¤„ç†ä¸é”™è¯¯æ£€æµ‹
            </div>
            <p>æå–å‘˜å·¥æ‰“å¡æ•°æ®ï¼Œæ£€æµ‹æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œç”Ÿæˆé«˜äº®æ ‡è®°çš„é”™è¯¯æ£€æŸ¥è¡¨</p>
            <div class="step-options">
                <button class="btn" id="step1Btn" onclick="processStep1()" disabled>å¼€å§‹é¢„å¤„ç†</button>
                <button class="btn warning" id="uploadErrorBtn" onclick="uploadErrorFile()" disabled>ä¸Šä¼ ä¿®æ”¹åçš„é”™è¯¯è¡¨æ ¼</button>
            </div>
            <div class="loading" id="step1Loading"><div class="spinner"></div><div>æ­£åœ¨å¤„ç†...</div></div>
            <div class="result" id="step1Result"></div>
        </div>

        <div class="step" id="step3">
            <div class="step-title">
                <span class="step-number">3</span>
                å·¥æ—¶è®¡ç®—ä¸è€ƒå‹¤åˆ†æ
            </div>
            <p>è®¡ç®—å·¥ä½œæ—¶é—´ã€åŠ ç­æ—¶é—´ï¼Œæ£€æµ‹è¿Ÿåˆ°æ—©é€€ï¼Œç”Ÿæˆå®Œæ•´çš„è€ƒå‹¤æŠ¥å‘Š</p>
            <button class="btn" id="step2Btn" onclick="processStep2()" disabled>ç”ŸæˆæŠ¥å‘Š</button>
            <div class="loading" id="step2Loading"><div class="spinner"></div><div>æ­£åœ¨ç”Ÿæˆ...</div></div>
            <div class="result" id="step2Result"></div>
        </div>

        <div class="step" id="step4">
            <div class="step-title">
                <span class="step-number">4</span>
                ä¸‹è½½ç»“æœæ–‡ä»¶
            </div>
            <div class="download-area" id="downloadArea" style="display: none;">
                <button class="btn success" id="downloadErrorBtn" onclick="downloadFile()" style="display: none;">ğŸ“¥ ä¸‹è½½é”™è¯¯æ£€æŸ¥è¡¨</button>
                <button class="btn success" id="downloadFinalBtn" onclick="downloadFinalFile()" style="display: none;">ğŸ“Š ä¸‹è½½æœ€ç»ˆæŠ¥å‘Š</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let uploadedFilename = '', timeRange = '', errorFilename = '', finalFilename = '';

        document.getElementById('file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileInfo').innerHTML = '<strong>å·²é€‰æ‹©:</strong> ' + file.name + '<br><strong>å¤§å°:</strong> ' + (file.size / 1024 / 1024).toFixed(2) + ' MB';
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false;
            }
        });

        async function uploadFile() {
            const file = document.getElementById('file').files[0];
            if (!file) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }

            const formData = new FormData();
            formData.append('file', file);

            showLoading('uploadLoading');
            try {
                const response = await fetch(API_BASE + '/upload', { method: 'POST', body: formData });
                const result = await response.json();
                hideLoading('uploadLoading');

                if (result.success) {
                    uploadedFilename = result.filename;
                    showResult('uploadResult', 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
                    completeStep('step1');
                    activateStep('step2');
                    document.getElementById('step1Btn').disabled = false;
                } else {
                    showResult('uploadResult', 'ä¸Šä¼ å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                hideLoading('uploadLoading');
                showResult('uploadResult', 'ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function processStep1() {
            showLoading('step1Loading');
            try {
                const response = await fetch(API_BASE + '/process/step1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: uploadedFilename })
                });
                const result = await response.json();
                hideLoading('step1Loading');

                if (result.success) {
                    timeRange = result.time_range;
                    errorFilename = result.output_file;

                    let message = '<div class="summary-box">' +
                        '<div class="summary-item">ğŸ‘¥ å‘˜å·¥æ•°é‡: ' + result.employee_count + '</div>' +
                        '<div class="summary-item">ğŸ“… æ—¶é—´èŒƒå›´: ' + timeRange + '</div>' +
                        '<div class="summary-item">ğŸ” é”™è¯¯æ•°é‡: ' + result.error_count + '</div>' +
                        '<div class="summary-item">âš ï¸ é«˜äº®å•å…ƒæ ¼: ' + result.total_highlighted + '</div>' +
                        '</div>';

                    if (result.error_details && result.error_details.length > 0) {
                        message += '<div class="collapsible" onclick="toggleContent(\'errorDetails1\')">ğŸ“‹ é”™è¯¯è¯¦æƒ… (ç‚¹å‡»å±•å¼€)</div>' +
                            '<div id="errorDetails1" class="content">' +
                            '<div class="error-details">';
                        result.error_details.forEach(function(detail) {
                            message += '<div class="error-item">â€¢ ' + detail + '</div>';
                        });
                        message += '</div></div>';
                    }

                    // æ·»åŠ å¼‚å¸¸ç±»å‹é¢œè‰²è¯´æ˜
                    message += '<div class="collapsible" onclick="toggleContent(\'colorLegend1\')">ğŸ¨ å¼‚å¸¸ç±»å‹é¢œè‰²è¯´æ˜ (ç‚¹å‡»å±•å¼€)</div>' +
                        '<div id="colorLegend1" class="content">' +
                        '<div class="error-details">' +
                        '<div class="error-item"><span style="background-color: #FFC7CE; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">æµ…çº¢è‰²</span>å†’å·è·ç¦»å¼‚å¸¸ - æ—¶é—´æ ¼å¼é—®é¢˜</div>' +
                        '<div class="error-item"><span style="background-color: #FF0000; padding: 2px 6px; border-radius: 3px; margin-right: 8px; color: white;">æ·±çº¢è‰²</span>å¥‡æ•°æ—¶é—´è®°å½• - æ‰“å¡æ¬¡æ•°ä¸åŒ¹é…</div>' +
                        '<div class="error-item"><span style="background-color: #FF8C00; padding: 2px 6px; border-radius: 3px; margin-right: 8px; color: white;">æ·±æ©™è‰²</span>æ—¶é—´é¡ºåºé”™è¯¯ - æ—¶é—´é¡ºåºæ··ä¹±</div>' +
                        '<div class="error-item"><span style="background-color: #FF6B6B; padding: 2px 6px; border-radius: 3px; margin-right: 8px; color: white;">æ©™çº¢è‰²</span>æ—¶é—´æ ¼å¼æ— æ•ˆ - æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†</div>' +
                        '<div class="error-item"><span style="background-color: #9932CC; padding: 2px 6px; border-radius: 3px; margin-right: 8px; color: white;">ç´«è‰²</span>è§£æé”™è¯¯ - æ— æ³•è§£æçš„æ•°æ®</div>' +
                        '<div class="error-item"><span style="background-color: #87CEEB; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">å¤©è“è‰²</span>æ··åˆåˆ†éš”ç¬¦ - å¤šç§åˆ†éš”ç¬¦æ··ç”¨</div>' +
                        '<div class="error-item"><span style="background-color: #FFD700; padding: 2px 6px; border-radius: 3px; margin-right: 8px;">é‡‘è‰²</span>å·¥ä½œæ—¶é—´è·¨åº¦å¼‚å¸¸ - å·¥ä½œæ—¶é—´è¿‡é•¿</div>' +
                        '</div></div>';

                    message += '<br><strong>ğŸ’¡ æç¤ºï¼š</strong>æ‚¨å¯ä»¥ä¸‹è½½é”™è¯¯æ£€æŸ¥è¡¨ï¼Œä¿®æ”¹åé‡æ–°ä¸Šä¼ ï¼Œæˆ–è€…ç›´æ¥ç»§ç»­ä¸‹ä¸€æ­¥ã€‚';

                    showResult('step1Result', message, 'success');
                    document.getElementById('uploadErrorBtn').disabled = false;
                    document.getElementById('step2Btn').disabled = false;
                    document.getElementById('downloadErrorBtn').style.display = 'inline-block';
                    document.getElementById('downloadArea').style.display = 'block';
                } else {
                    showResult('step1Result', 'å¤„ç†å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                hideLoading('step1Loading');
                showResult('step1Result', 'å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function uploadErrorFile() {
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('time_range', timeRange);

                showLoading('step1Loading');
                try {
                    const response = await fetch(API_BASE + '/upload/error', { method: 'POST', body: formData });
                    const result = await response.json();
                    hideLoading('step1Loading');

                    if (result.success) {
                        errorFilename = result.filename;
                        showResult('step1Result', 'ä¿®æ”¹åçš„é”™è¯¯è¡¨æ ¼ä¸Šä¼ æˆåŠŸï¼ç°åœ¨å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ã€‚', 'success');
                        document.getElementById('step2Btn').disabled = false;
                    } else {
                        showResult('step1Result', 'ä¸Šä¼ å¤±è´¥: ' + result.error, 'error');
                    }
                } catch (error) {
                    hideLoading('step1Loading');
                    showResult('step1Result', 'ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                }
            };

            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        async function processStep2() {
            showLoading('step2Loading');
            try {
                const response = await fetch(API_BASE + '/process/step2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ error_filename: errorFilename, time_range: timeRange })
                });
                const result = await response.json();
                hideLoading('step2Loading');

                if (result.success) {
                    finalFilename = result.output_file;

                    let message = '<div class="summary-box">' +
                        '<div class="summary-item">ğŸ‘¥ å¤„ç†å‘˜å·¥: ' + result.employee_count + '</div>' +
                        '<div class="summary-item">â° æ€»å·¥æ—¶: ' + (result.total_working_hours ? result.total_working_hours.toFixed(1) : 0) + 'h</div>' +
                        '<div class="summary-item">ğŸ”„ åŠ ç­æ—¶é—´: ' + (result.total_overtime ? result.total_overtime.toFixed(1) : 0) + 'h</div>' +
                        '<div class="summary-item">ğŸ”¥ é—®é¢˜æ•°æ®: ' + result.problematic_cells_count + '</div>' +
                        '</div>';

                    if (result.attendance_summary) {
                        message += '<div class="summary-box">' +
                            '<div class="summary-item" style="color: #dc3545;">ğŸŒ è¿Ÿåˆ°: ' + result.attendance_summary.late_count + 'æ¬¡</div>' +
                            '<div class="summary-item" style="color: #fd7e14;">ğŸ½ï¸ ä¸­åˆä¸æ‰“å¡: ' + result.attendance_summary.no_lunch_count + 'æ¬¡</div>' +
                            '<div class="summary-item" style="color: #6f42c1;">ğŸƒ æ—©é€€: ' + result.attendance_summary.early_leave_count + 'æ¬¡</div>' +
                            '</div>';
                    }

                    message += '<br><strong>ğŸ“Š Excelæ–‡ä»¶åŒ…å«4ä¸ªå·¥ä½œè¡¨ï¼š</strong><br>' +
                        'â€¢ æ—¶é—´æ±‡æ€»ï¼šåŸå§‹æ‰“å¡æ—¶é—´ + è®¡ç®—å·¥æ—¶ + ç»Ÿè®¡æ•°æ®<br>' +
                        'â€¢ è¿Ÿåˆ°ï¼šæ ‡çº¢è¿Ÿåˆ°è®°å½•<br>' +
                        'â€¢ ä¸­åˆä¸æ‰“å¡ï¼šæ ‡çº¢ä¸­åˆä¸æ‰“å¡è®°å½•<br>' +
                        'â€¢ æ—©é€€ï¼šæ ‡çº¢æ—©é€€è®°å½•<br><br>' +
                        '<strong>ğŸ¨ é¢œè‰²è¯´æ˜ï¼š</strong><br>' +
                        'â€¢ ğŸŸ¡ é»„è‰²ï¼šå·¥æ—¶ç»Ÿè®¡åˆ—<br>' +
                        'â€¢ ğŸ”´ æµ…çº¢è‰²ï¼šè¿Ÿåˆ°/æ—©é€€/ä¸­åˆä¸æ‰“å¡<br>' +
                        'â€¢ ğŸ”¥ æ·±çº¢è‰²ï¼šæœ‰é—®é¢˜çš„æ—¶é—´æ•°æ® (éœ€è¦äººå·¥ç¡®è®¤)<br>' +
                        'â€¢ ğŸŸ¢ ç»¿è‰²ï¼šå‡æœŸåˆ—<br><br>' +
                        '<strong>ğŸ“‹ å¼‚å¸¸ç±»å‹é¢œè‰²è¯´æ˜ï¼š</strong><br>' +
                        'â€¢ <span style="background-color: #FFC7CE; padding: 2px 6px; border-radius: 3px;">æµ…çº¢è‰²</span> å†’å·è·ç¦»å¼‚å¸¸<br>' +
                        'â€¢ <span style="background-color: #FF0000; padding: 2px 6px; border-radius: 3px; color: white;">æ·±çº¢è‰²</span> å¥‡æ•°æ—¶é—´è®°å½•<br>' +
                        'â€¢ <span style="background-color: #FF8C00; padding: 2px 6px; border-radius: 3px; color: white;">æ·±æ©™è‰²</span> æ—¶é—´é¡ºåºé”™è¯¯<br>' +
                        'â€¢ <span style="background-color: #FF6B6B; padding: 2px 6px; border-radius: 3px; color: white;">æ©™çº¢è‰²</span> æ—¶é—´æ ¼å¼æ— æ•ˆ<br>' +
                        'â€¢ <span style="background-color: #9932CC; padding: 2px 6px; border-radius: 3px; color: white;">ç´«è‰²</span> è§£æé”™è¯¯<br>' +
                        'â€¢ <span style="background-color: #87CEEB; padding: 2px 6px; border-radius: 3px;">å¤©è“è‰²</span> æ··åˆåˆ†éš”ç¬¦<br>' +
                        'â€¢ <span style="background-color: #FFD700; padding: 2px 6px; border-radius: 3px;">é‡‘è‰²</span> å·¥ä½œæ—¶é—´è·¨åº¦å¼‚å¸¸<br>' +
                        'â€¢ <span style="background-color: #FF4500; padding: 2px 6px; border-radius: 3px; color: white;">æ©™çº¢è‰²</span> è®¡ç®—é”™è¯¯<br>' +
                        'â€¢ <span style="background-color: #FFB6C1; padding: 2px 6px; border-radius: 3px;">æµ…ç²‰è‰²</span> é›¶å·¥æ—¶';

                    showResult('step2Result', message, 'success');
                    completeStep('step3');
                    completeStep('step4');
                    document.getElementById('downloadFinalBtn').style.display = 'inline-block';
                } else {
                    showResult('step2Result', 'å¤„ç†å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                hideLoading('step2Loading');
                showResult('step2Result', 'å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        function downloadFile() {
            if (errorFilename) window.open(API_BASE + '/download/' + errorFilename, '_blank');
        }

        function downloadFinalFile() {
            if (finalFilename) window.open(API_BASE + '/download/' + finalFilename, '_blank');
        }

        function toggleContent(id) {
            const content = document.getElementById(id);
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }

        function showLoading(id) { document.getElementById(id).style.display = 'block'; }
        function hideLoading(id) { document.getElementById(id).style.display = 'none'; }
        function showResult(id, message, type) {
            const element = document.getElementById(id);
            element.innerHTML = message;
            element.className = 'result ' + type;
            element.style.display = 'block';
        }
        function activateStep(stepId) { document.getElementById(stepId).classList.add('active'); }
        function completeStep(stepId) {
            const step = document.getElementById(stepId);
            step.classList.remove('active');
            step.classList.add('completed');
        }
    </script>
</body>
</html> 